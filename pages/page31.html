<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Local Drive - Pro (ZIP Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg: #c66e97;
            --panel: #1b2050;
            --soft: #a53ac5;
            --accent: #a0f0d9;
            --accent-2: #00c9a7;
            --text: #00c9a7;
            --muted: #9ae9d7;
            --border: #2b2f66;
        }
        * { box-sizing: border-box; }
        body { 
            margin: 0; background: linear-gradient(180deg, var(--bg), #0b0e1e 60%); 
            color: var(--text); font: 14px/1.4 system-ui, sans-serif; min-height: 100vh;
            display: flex; flex-direction: column;
        }
        
        header { position: sticky; top: 0; z-index: 10; background: rgba(15, 18, 38, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); }
        .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
        .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 12px; }
        
        .storage-box { font-size: 11px; color: var(--muted); margin-top: 4px; display: flex; align-items: center; gap: 8px; }
        .meter-bar { width: 100px; height: 6px; background: #2b2f66; border-radius: 3px; overflow: hidden; }
        .meter-fill { height: 100%; background: var(--accent-2); width: 0%; transition: width 0.3s; }

        .breadcrumbs { display: flex; gap: 8px; margin-bottom: 10px; font-size: 16px; color: var(--accent); overflow-x: auto; scrollbar-width: none; }
        .crumb { cursor: pointer; white-space: nowrap; text-decoration: underline; }
        .crumb:after { content: '/'; margin-left: 8px; color: var(--muted); text-decoration: none; }

        button, .file-label {
            background: linear-gradient(180deg, #1b2050, #151a44); border: 1px solid var(--border);
            color: var(--text); padding: 8px 14px; border-radius: 10px; cursor: pointer;
            transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; font-size: 13px;
        }
        button:hover:not(:disabled) { border-color: var(--accent); transform: translateY(-1px); background: #1f255e; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        input[type=file] { display: none; }

        main { flex: 1; max-width: 1200px; margin: 0 auto; width: 100%; padding: 20px 16px; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; }

        .item {
            background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
            border-radius: 12px; padding: 10px; text-align: center; transition: 0.2s; position: relative; cursor: pointer;
            overflow: hidden;
        }
        .item:hover { background: rgba(255, 255, 255, 0.08); border-color: var(--soft); }
        .item.selected { border-color: var(--accent-2); background: rgba(0, 201, 167, 0.1); }
        
        .thumbnail-wrapper {
            width: 100%; height: 110px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 8px; overflow: hidden; border-radius: 8px; background: rgba(0,0,0,0.3);
        }
        .thumb-preview { width: 100%; height: 100%; object-fit: cover; }
        .icon { font-size: 42px; display: block; }

        .item-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 4px; }
        .item-check { position: absolute; top: 10px; left: 10px; z-index: 2; width: 18px; height: 18px; cursor: pointer; }

        dialog { 
            background: #0e1333; color: var(--text); border: 1px solid var(--border); 
            border-radius: 16px; padding: 20px; max-width: 850px; width: 95%;
        }
        dialog::backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(6px); }
        .modal-body { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 250px; }
        .preview-content { max-width: 100%; max-height: 75vh; border-radius: 8px; }

        #sentinel { height: 40px; }
        .hidden { display: none; }
        input[type=text] { width: 100%; padding: 12px; margin: 15px 0; background: #07091a; border: 1px solid var(--border); color: white; border-radius: 8px; }
    </style>
</head>
<body>

<header>
    <div class="wrap">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h1 style="margin:0">Local Drive <small style="font-size: 12px; color: var(--soft)">PRO</small></h1>
                <div class="storage-box">
                    <div class="meter-bar"><div id="meterFill" class="meter-fill"></div></div>
                    <span id="storageText">Calculating storage...</span>
                </div>
            </div>
        </div>
        
        <div class="breadcrumbs" id="breadcrumbs" style="margin-top: 15px;"></div>
        
        <div class="toolbar">
            <label class="file-label">üì§ Upload <input id="fileInput" type="file" multiple /></label>
            <button id="btnNewFolder">üìÅ New Folder</button>
            <button id="btnSelectAll">‚úÖ Select All</button>
            <button id="btnDelete" disabled>üóëÔ∏è Delete</button>
            <button id="btnRename" disabled>‚úèÔ∏è Rename</button>
            <button id="btnDownload" disabled>üì• Download</button>
            <div style="flex-grow: 1;"></div>
            <button id="btnExport" title="Backup Current Context">üíæ Backup (.zip)</button>
            <label class="file-label" title="Restore System">üì• Restore <input id="restoreInput" type="file" accept=".zip" /></label>
        </div>
    </div>
</header>

<main>
    <div id="fileGrid" class="file-grid"></div>
    <div id="sentinel"></div>
    <div id="emptyState" class="hidden" style="text-align: center; padding: 100px 20px; color: var(--muted);">
        <div style="font-size: 40px; margin-bottom: 10px;">‚òÅÔ∏è</div>
        Folder is empty.
    </div>
</main>

<dialog id="previewModal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
        <h3 id="previewTitle" style="margin:0;">File Preview</h3>
        <button onclick="previewModal.close()">‚úï</button>
    </div>
    <div id="previewBody" class="modal-body"></div>
</dialog>

<dialog id="promptModal">
    <h3 id="promptTitle">Prompt</h3>
    <input type="text" id="promptInput" spellcheck="false" />
    <div style="display:flex; gap:10px; justify-content: flex-end;">
        <button onclick="promptModal.close()">Cancel</button>
        <button id="promptConfirm" style="background:var(--accent-2); color:#000; font-weight: bold;">Confirm Action</button>
    </div>
</dialog>

<script>
/** ---------------------------------------------------------
 * CONFIG & DATABASE
 --------------------------------------------------------- **/
const DB_NAME = 'Drive13_Ultimate';
const STORE = 'fs';
let db, currentPath = "root", allItems = [], displayedCount = 0;
const PAGE_SIZE = 30;
const $ = s => document.querySelector(s);

async function initDB() {
    return new Promise((res, rej) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => {
            const os = e.target.result.createObjectStore(STORE, { keyPath: 'id' });
            os.createIndex('parent', 'parent', { unique: false });
        };
        req.onsuccess = () => { db = req.result; res(); };
        req.onerror = () => rej(req.error);
    });
}

const getStore = (m = 'readonly') => db.transaction([STORE], m).objectStore(STORE);

/** ---------------------------------------------------------
 * STORAGE MONITORING
 --------------------------------------------------------- **/
async function updateStorageMeter() {
    if (navigator.storage && navigator.storage.estimate) {
        const {usage, quota} = await navigator.storage.estimate();
        const percent = ((usage / quota) * 100).toFixed(1);
        $('#meterFill').style.width = percent + '%';
        const usedMB = (usage / (1024 * 1024)).toFixed(1);
        const totalMB = (quota / (1024 * 1024 * 1024)).toFixed(1);
        $('#storageText').textContent = `${usedMB} MB used of ~${totalMB} GB quota (${percent}%)`;
    }
}

/** ---------------------------------------------------------
 * RENDERING LOGIC
 --------------------------------------------------------- **/
async function refresh() {
    selections.clear();
    $('#fileGrid').innerHTML = '';
    displayedCount = 0;
    
    allItems = [];
    const index = getStore().index('parent');
    const range = IDBKeyRange.only(currentPath);
    
    return new Promise(res => {
        index.openCursor(range).onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                allItems.push(cursor.value);
                cursor.continue();
            } else {
                allItems.sort((a,b) => (b.isFolder - a.isFolder) || a.name.localeCompare(b.name));
                loadMore();
                updateUI();
                updateBreadcrumbs();
                updateStorageMeter();
                res();
            }
        };
    });
}

function loadMore() {
    const grid = $('#fileGrid');
    const batch = allItems.slice(displayedCount, displayedCount + PAGE_SIZE);
    
    batch.forEach(item => {
        const div = document.createElement('div');
        div.className = `item`;
        div.dataset.id = item.id;
        
        let thumbHTML = '';
        const isImage = item.data && (item.data.type?.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp)$/i.test(item.name));
        
        if (!item.isFolder && isImage) {
            const url = URL.createObjectURL(item.data);
            thumbHTML = `<img src="${url}" class="thumb-preview" loading="lazy">`;
        } else {
            thumbHTML = `<span class="icon">${item.isFolder ? 'üìÅ' : getIcon(item.name)}</span>`;
        }

        div.innerHTML = `
            <input type="checkbox" class="item-check">
            <div class="thumbnail-wrapper">${thumbHTML}</div>
            <div class="item-name" title="${item.name}">${item.name}</div>
        `;

        div.onclick = (e) => {
            if(e.target.className === 'item-check') { 
                toggleSelect(item.id, div); 
                return; 
            }
            if(item.isFolder) { currentPath += '/' + item.name; refresh(); } 
            else { showPreview(item); }
        };
        grid.appendChild(div);
    });
    displayedCount += batch.length;
    $('#emptyState').classList.toggle('hidden', allItems.length > 0);
}

function getIcon(n) {
    const e = n.split('.').pop().toLowerCase();
    if (['mp4','webm','mov'].includes(e)) return 'üé¨';
    if (['pdf'].includes(e)) return 'üìÑ';
    if (['mp3','wav'].includes(e)) return 'üéµ';
    return 'üìÑ';
}

/** ---------------------------------------------------------
 * RECURSIVE DELETE LOGIC
 --------------------------------------------------------- **/
async function deleteItemRecursive(id, store) {
    return new Promise((resolve) => {
        store.get(id).onsuccess = async (e) => {
            const item = e.target.result;
            if (!item) return resolve();

            if (item.isFolder) {
                const index = store.index('parent');
                index.openCursor(IDBKeyRange.only(item.parent + "/" + item.name)).onsuccess = async (ev) => {
                    const cursor = ev.target.result;
                    if (cursor) {
                        await deleteItemRecursive(cursor.value.id, store);
                        cursor.continue();
                    } else {
                        store.delete(id);
                        resolve();
                    }
                };
            } else {
                store.delete(id);
                resolve();
            }
        };
    });
}

$('#btnDelete').onclick = async () => {
    if(!confirm(`Delete ${selections.size} items?`)) return;
    const tx = db.transaction([STORE], 'readwrite');
    const store = tx.objectStore(STORE);
    for (let id of selections) await deleteItemRecursive(id, store);
    tx.oncomplete = () => refresh();
};

/** ---------------------------------------------------------
 * SELECTION & TOOLBAR
 --------------------------------------------------------- **/
let selections = new Set();
function toggleSelect(id, element) {
    const cb = element.querySelector('.item-check');
    if(selections.has(id)) {
        selections.delete(id);
        element.classList.remove('selected');
        cb.checked = false;
    } else {
        selections.add(id);
        element.classList.add('selected');
        cb.checked = true;
    }
    updateUI();
}

$('#btnSelectAll').onclick = () => {
    const items = document.querySelectorAll('.item');
    const allCurrentlySelected = Array.from(items).every(el => selections.has(el.dataset.id));
    items.forEach(el => {
        const cb = el.querySelector('.item-check');
        if (allCurrentlySelected) {
            selections.delete(el.dataset.id);
            el.classList.remove('selected');
            cb.checked = false;
        } else {
            selections.add(el.dataset.id);
            el.classList.add('selected');
            cb.checked = true;
        }
    });
    updateUI();
};

function updateUI() {
    $('#btnDelete').disabled = selections.size === 0;
    $('#btnRename').disabled = selections.size !== 1;
    $('#btnDownload').disabled = selections.size === 0;
    $('#btnSelectAll').textContent = selections.size === allItems.length && allItems.length > 0 ? "‚ùå Deselect All" : "‚úÖ Select All";
}

/** ---------------------------------------------------------
 * BACKUP & RESTORE
 --------------------------------------------------------- **/
 

$('#btnExport').onclick = async () => {
    const btn = $('#btnExport');
    btn.disabled = true;
    const isRoot = currentPath === "root";
    btn.textContent = "‚åõ Zipping...";

    try {
        const zip = new JSZip();
        const manifest = [];
        const tx = db.transaction([STORE], 'readonly');
        const store = tx.objectStore(STORE);
        const request = isRoot ? store.openCursor() : store.index('parent').openCursor(IDBKeyRange.only(currentPath));

        await new Promise((resolve) => {
            request.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const { data, ...metadata } = cursor.value;
                    // Preserve the MIME type in manifest
                    metadata.mimeType = data?.type || ''; 
                    manifest.push(metadata);
                    if (!cursor.value.isFolder && data) zip.file(`data/${metadata.id}`, data);
                    cursor.continue();
                } else resolve();
            };
        });

        zip.file("manifest.json", JSON.stringify(manifest));
        const content = await zip.generateAsync({ type: "blob" });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = `Drive_Backup_${new Date().getTime()}.zip`;
        a.click();
    } catch (err) { alert(err.message); }
    finally { btn.disabled = false; btn.textContent = "üíæ Backup (.zip)"; }
};

$('#restoreInput').onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    try {
        const zip = await JSZip.loadAsync(file);
        const manifest = JSON.parse(await zip.file("manifest.json").async("string"));
        
        const itemsWithData = await Promise.all(manifest.map(async m => {
            if(!m.isFolder) {
                const blobData = await zip.file(`data/${m.id}`).async("blob");
                // Restore with original MIME type (Crucial for GIF/Video)
                m.data = new Blob([blobData], { type: m.mimeType || 'application/octet-stream' });
            }
            return m;
        }));

        const tx = db.transaction([STORE], 'readwrite');
        itemsWithData.forEach(item => tx.objectStore(STORE).put(item));
        tx.oncomplete = () => { alert("Restored Successfully!"); refresh(); };
    } catch(err) { alert("Restore Failed: " + err.message); }
};

/** ---------------------------------------------------------
 * UI HELPERS
 --------------------------------------------------------- **/
function updateBreadcrumbs() {
    const parts = currentPath.split('/').filter(Boolean);
    const container = $('#breadcrumbs');
    container.innerHTML = `<span class="crumb" onclick="jumpTo('root')">Drive</span>`;
    let acc = "root";
    parts.forEach(p => {
        if(p === "root") return;
        acc += "/" + p;
        const target = acc;
        const span = document.createElement('span');
        span.className = 'crumb'; span.textContent = p;
        span.onclick = () => jumpTo(target);
        container.appendChild(span);
    });
}

function jumpTo(p) { currentPath = p; refresh(); }

function showPreview(item) {
    const url = URL.createObjectURL(item.data);
    $('#previewTitle').textContent = item.name;
    const body = $('#previewBody');
    const type = item.data.type;

    if (type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp)$/i.test(item.name)) {
        body.innerHTML = `<img src="${url}" class="preview-content">`;
    } else if (type.startsWith('video/')) {
        body.innerHTML = `<video src="${url}" controls autoplay class="preview-content"></video>`;
    } else {
        body.innerHTML = `<p>No Preview Available for this file type.</p>`;
    }
    
    $('#previewModal').showModal();
    $('#previewModal').onclose = () => URL.revokeObjectURL(url);
}

$('#fileInput').onchange = async (e) => {
    const tx = db.transaction([STORE], 'readwrite');
    for(const f of e.target.files) {
        tx.objectStore(STORE).put({ id: crypto.randomUUID(), name: f.name, parent: currentPath, isFolder: false, data: f });
    }
    tx.oncomplete = () => refresh();
};

$('#btnNewFolder').onclick = () => {
    $('#promptTitle').textContent = "Folder Name";
    $('#promptInput').value = "";
    $('#promptModal').showModal();
    $('#promptConfirm').onclick = () => {
        const val = $('#promptInput').value.trim();
        if(val) {
            const tx = db.transaction([STORE], 'readwrite');
            tx.objectStore(STORE).put({ id: crypto.randomUUID(), name: val, parent: currentPath, isFolder: true });
            tx.oncomplete = () => { $('#promptModal').close(); refresh(); };
        }
    };
};

(async () => {
    await initDB();
    refresh();
})();
</script>
</body>
</html>
